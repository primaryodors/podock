<html>
<head>
<meta charset="UTF-8">
<title>Viewer - podock</title>
<script src="https://code.jquery.com/jquery-3.6.0.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>

<script>
var nglcitation
	= "AS Rose, AR Bradley, Y Valasatava, JM Duarte, A PrliÄ‡ and PW Rose.\n"
	+ "Web-based molecular graphics for large complexes.\n"
	+ "ACM Proceedings of the 21st International Conference on Web3D Technology (Web3D '16):\n"
	+ "185-186, 2016. doi:10.1145/2945292.2945324\n"
	+ "\n"
	+ "AS Rose and PW Hildebrand.\n"
	+ "NGL Viewer: a web application for molecular visualization.\n"
	+ "Nucl Acids Res (1 July 2015) 43 (W1):\n"
	+ "W576-W579 first published online April 29, 2015.\n"
	+ "doi:10.1093/nar/gkv402";
</script>
<style>
body
{
	color: #69c;
	overflow: hidden;
}

a
{	color: #2af;
	text-decoration: none;
}
a:hover
{
	text-decoration: underline;
}

#pleasewait
{
	position: fixed;
	top: 22%;
	left: 40%;
	right: 40%;
	width: 20%;
	text-align: center;
	background-color: rgba(0,11,31,0.67);
	color: #def;
	padding: 15px;
	border-radius: 25px;
	box-shadow: 0px 0px 41px rgba(0,0,0,0.22), 5px 3px 5px rgba(0,0,0,0.41);
}

#citefloat
{
	position: fixed;
	text-align: right;
    right: 25px;
    bottom: 15px;
	font-family: Verdana, Arial, Sans-Serif;
    font-size: 11px;
	color: #06c;
}

#citefloat span
{
    background-color: rgba(0,0,0,0.53);
	color: rgba(0, 128, 255, 0);
	font-size: 15px;
	transition: color 2s, height 2s;
	text-align: left;
	display: block;
	height: 0px;
	overflow: hidden;
}

#citefloat:hover span
{
	color: rgba(192, 192, 192, 1);
	display: block;
	height: auto;
}

#ctrls div
{
    margin-left: 15px;
}

#posey
{
	background-color: #123;
    min-width: 71px;
    padding-left: 5px;
    padding-right: 5px;
}

.clickme, .clickme:hover
{
	cursor: pointer;
	text-decoration: none;
}

.clickme:hover
{
	color: #9cf;
}

.posebtn
{
	background-color: #246;
    border-top: 2px solid #47a;
    border-left: 2px solid #369;
    border-right: 2px solid #234;
    border-bottom: 2px solid #123;
    border-radius: 5px;
    padding-left: 3px;
    padding-right: 3px;
    margin-left: 2px;
    margin-right: 2px;
	cursor: pointer;
    font-size: 14px;
	font-family: Verdana, Arial, sans-serif;
}

.posebtn.hilite
{
	background-color: #369;
    border-top: 2px solid #68a;
    border-left: 2px solid #579;
    border-right: 2px solid #246;
    border-bottom: 2px solid #135;
}

.nodebtn
{
	background-color: #234;
    padding-left: 5px;
    padding-right: 5px;
    margin-left: 0px;
    margin-right: 0px;
	cursor: pointer;
    font-size: 14px;
	font-family: Verdana, Arial, sans-serif;
}

.nodebtn.hilite
{
	background-color: #357;
}

.symbol
{	font-size: 20px!important;
}

input[type=file]
{
    /*width: 600px;*/
}

input, select
{
	background-color: #036;
	color: #9cf;
    border: 1px solid #06c;
    border-radius: 5px;
}

option.agonist
{
	background-color: #044;
	color: #9ef;
	font-weight: bold;
}

option.non_agonist
{
	background-color: #234;
	color: #bcd;
}

option.antagonist
{
	background-color: #410;
	color: #fb9;
}

option.unknown
{
	background-color: #000;
	color: #999;
}

#clip
{
    width: 400px;
}

#seqdd
{
	background-color: #235;
	position: absolute;
	display: block;
	top: 25px;
	/*left: 225px;*/
	right: 5px;
	z-index: 1000;
	padding: 10px;
	border: 1px solid #249;
	border-radius: 15px;
}

.sctgbtn
{
	font-family: Monospace;
	margin-bottom: 10px;
}

.sctgbtn.hilite
{
	border: 1px solid #35f;
    background-color: #345;
    color: #9cf;
}

.seqnumln
{
	font-family: Monospace;
	letter-spacing: 1.4px;
    margin-left: 5px;
    font-size: 13px;
}

</style>
<script src="https://unpkg.com/ngl@0.10.4/dist/ngl.js"></script>
<script>
/******************************************************************************/
// http://stackoverflow.com/questions/901115/how-can-i-get-query-string-values-in-javascript
function getParameterByName(name, url)
{
    if (!url)
    {
        url = window.location.href;
    }
    name = name.replace(/[\[\]]/g, "\\$&");
    var regex = new RegExp("[?&]" + name + "(=([^&#]*)|&|#|$)"),
    results = regex.exec(url);
    if (!results) return null;
    if (!results[2]) return '';
    return decodeURIComponent(results[2].replace(/\+/g, " "));
}
/******************************************************************************/
</script>
</head>
<body bgcolor="#000">
<div id="ctrls" style="display: flex; flex-wrap: wrap;">
    <div id="filediv">
		<input type="file">
    </div>

<div id="posey" title="Use the A-Z keys or the up and down arrow keys to choose poses when viewing dock results.">&nbsp;
</div>

<div id="pnodz"
     title="Use the 0-9 keys or the left and right arrow keys to choose nodes when viewing dock results. Shift+A-Z selects nodes 10 - 35."
     >&nbsp;
</div>

<div id="clipslide">
Clip:
<input type="range" id="clip" min="0" max="100" step="1" value="0" class="slider" onkeyup="this.blur();">
<span id="prsv" style="display: none;">
<input type="checkbox" id="preserve" checked onchange="$('#clip').trigger('input');"> Preserve Ligand
</span>
</div>

<div id="affichage">
<a id="sdchbtn" class="nodebtn clickme symbol" onclick="show_seqdd();" title="Side Chains">&#x232C;</a>
</div>

<div id="center">
Center:
<a class="posebtn clickme" onclick="gmodel[0].autoView();" title="Middle-click an atom to center it.">Model</a>
<a class="posebtn clickme" onclick="curr_ligand.autoView();" id="ligbtn" style="display: none;">Ligand</a>
</div>
</div>
<center>
<div id="viewport" style="width:1800px; height:880px; background-color: #000;"></div>
</center>
<script>

const aa1let = "ARNDCEQGHILKMFPSTWYVU";
const aa3let =
[
	'ALA', 'ARG', 'ASN', 'ASP', 'CYS',
	'GLU', 'GLN', 'GLY', 'HIS', 'ILE',
	'LEU', 'LYS', 'MET', 'PHE', 'PRO',
	'SER', 'THR', 'TRP', 'TYR', 'VAL',
	'SEC',
];

function aa_1let_from_3let(laa3let)
{
	var retval = "?";
	aa3let.forEach(function(item, index)
	{
		if (item == laa3let) retval = aa1let.substr(index, 1);
	});
	return retval;
}

var tmoid = false;
function show_seqdd()
{
	var seqdd = $('#seqdd')[0];
	seqdd.innerHTML = "<b>Show/Hide Side Chains:</b><br><br>";
	
	var i;
	var span = document.createElement("span");
	var dots = ". . . . . . . . .";
	var dotslen = dots.length;
	span.innerText = dots+"10 "+dots+"20 "+dots+"30";
	span.className = "seqnumln";
	span.appendChild(document.createElement("br"));
	seqdd.appendChild(span);
	var seqoff = 40;
	for (i=0; i<sequence.length; i++)
	{
		var tgl = document.createElement("span");
		tgl.className = "clickme nodebtn sctgbtn" + (restoggled[i+1] ? " hilite" : "");
		tgl.innerText = sequence.substr(i, 1);
		tgl.id = "seqddtgl" + (i+1);
		tgl.title = sequence.substr(i, 1)+(i+1);
		tgl.setAttribute("onclick", "event.preventDefault(); toggleSideChain("+(i+1)+"); return false;");
		tgl.setAttribute("ondblclick", "event.preventDefault(); return false;");
		tgl.setAttribute("onmousedown", "event.preventDefault(); return false;");
		tgl.setAttribute("onmousemove", "event.preventDefault(); return false;");
		seqdd.appendChild(tgl);
		
		if (!((i+1)%30))
		{
			seqdd.appendChild(document.createElement("br"));
			seqdd.appendChild(document.createElement("br"));
			span = document.createElement("span");
			
			if (seqoff >= 100) dots = dots.substr(0, dotslen-(seqoff.toString().length-2));
			span.innerText = dots+seqoff;
			seqoff += 10; 
			span.innerText += " "+dots+seqoff;
			seqoff += 10;
			span.innerText += " "+dots+seqoff;
			seqoff += 10;
			
			span.className = "seqnumln";
			span.appendChild(document.createElement("br"));
			seqdd.appendChild(span);
		}
	}
	
	var sdchbtn = $('#sdchbtn')[0];
	var btnrect = sdchbtn.getBoundingClientRect();
	$(seqdd
		).css("top", parseInt(btnrect.bottom).toString()+"px"
		// ).css("left", parseInt(btnrect.left).toString()+"px"
		).toggle().on("mouseleave", function()
		{
			if (tmoid) window.clearTimeout(tmoid);
			tmoid = window.setTimeout(function()
			{
				$('#seqdd').hide();
			}, 1000);
		}).on("mousemove", function()
		{
			if (tmoid) window.clearTimeout(tmoid);
		});
	
}

// Can modify this array to your preferred TMR color scheme.
var tmcolor =
{
    1: 0x666666,
    2: 0x993366,
    3: 0x0033ff,
    4: 0x3399cc,
    5: 0x00ff99,
    6: 0x33ff00,
    7: 0xcc7733
};

/*var tmcolor =
{
    1: 0x666666,
    2: 0x0099ff,
    3: 0x00ff66,
    4: 0x6600ff,
    5: 0xccff00,
    6: 0xff9900,
    7: 0xcc0033
};*/

var stage = new NGL.Stage("viewport");
var gmodel = [], model = [], is_ligand = [], mrep = [], mrparams = [], mpos = [], mnod = [];
var resmdl = [], restoggled = [];
var curr_ligand = false;
var gpose = 1, gnode = 0;
var orid;
var mtlcoord = [];
var tmstart = {1: 0, 2: 0, 3: 0, 4: 0, 5: 0, 6: 0, 7: 0}, tmend = {1: 0, 2: 0, 3: 0, 4: 0, 5: 0, 6: 0, 7: 0};
var sequence = "";

$("#affichage").hide();

window.onresize = function()
{
    var w = parseInt(window.visualViewport.width - $("#viewport")[0].getBoundingClientRect().top - 5);
    var h = parseInt(window.visualViewport.height - 5);
    $('#viewport').css("width", w+"px").css("height",h+"px");
    stage.setSize(w, h);
};
window.onresize();

stage.mouseControls.add( "scroll-ctrl+shift", function( stage, delta )
{
    var ai = stage.getParameters().ambientIntensity;
    stage.setParameters( { ambientIntensity: Math.max( 0, ai + delta / 50 ) } );
} );

stage.mouseControls.add("clickPick", function(stage, e)
{
	toggleSideChain(e.atom.resno);
});

function toggleSideChain(resno)
{
	try
	{
		if (restoggled[resno]) // resmdl[e.atom.resno].hasRepresentation())
		{
			resmdl[resno].removeAllRepresentations();
			restoggled[resno] = 0;
			$('#seqddtgl'+resno).removeClass('hilite');
		}
		else
		{
			resmdl[resno].addRepresentation( "licorice",
            {
                opacity: 0.7,
				colorScheme: PODefScheme,
                metalness: 0.13,
            });
			restoggled[resno] = 1;
			$('#seqddtgl'+resno).addClass('hilite');
		}
	}
	catch (ex)
	{
		;
	}
}

var PODefScheme = NGL.ColormakerRegistry.addScheme(function (params)
{
    this.atomColor = function (atom)
    {
        switch (atom.atomType.element)
        {
        	case 'H': return atom.isBackbone() ? 0x79949b : 0xd1f5ff;
            
        	case 'C':
            if (atom.isBackbone()) return 0x666666;
            else switch (atom.resname)
            {
                case 'GLY':
                return 0x999999;

                case 'ALA':
                case 'ILE':
                case 'LEU':
                case 'PRO':
                case 'VAL':
                return 0x808080;

                case 'MET':
                case 'CYS':
                case 'SEC':
                return 0x99aa77;

                case 'PHE':
                case 'TRP':
                case 'TYR':
                return 0x664466;

                case 'SER':
                case 'THR':
                case 'GLN':
                case 'ASN':
                return 0x66aa77;

                case 'ASP':
                case 'GLU':
                return 0xddbb99;

                case 'HIS':
                case 'LYS':
                case 'ARG':
                case 'PYL':
                return 0x99bbdd;

                default:
                return 0x666666;
            }

        	case 'N': return atom.isBackbone() ? 0x000066 : 0x0066FF;
        	case 'O': return atom.isBackbone() ? 0x660000 : 0xFF0000;
        	case 'P': return 0xff77c6;
        	case 'S': return 0xffdd00;
        	case 'Se': return 0xffaa00;
        	case 'Cl': return 0x33cc00;
        	case 'Cu': return 0xe5a072;
        	case 'Zn': return 0x92b0cc;
        	case 'Na': return 0xffcc00;
        	case 'Mg': return 0x99ffcc;
        	case 'K': return 0x9966ff;
        	case 'Ca': return 0xf7f7f7;
        	case 'Fe': return 0x845f42;

        	default: return 0x99aabb;
        }

        return 0xcc00ff;
    };
});

var PODefSchemeHilite = NGL.ColormakerRegistry.addScheme(function (params)
{
    this.atomColor = function (atom)
    {
        switch (atom.atomType.element)
        {
        	case 'H': return atom.isBackbone() ? 0x79949b : 0xe1faff;
            
        	case 'C':
            if (atom.isBackbone()) return 0x666666;
            else switch (atom.resname)
            {
                case 'GLY':
                return 0xe0e0e0;

                case 'ALA':
                case 'ILE':
                case 'LEU':
                case 'PRO':
                case 'VAL':
                return 0xbbbbbb;

                case 'MET':
                case 'CYS':
                case 'SEC':
                return 0xddee99;

                case 'PHE':
                case 'TRP':
                case 'TYR':
                return 0xaa77aa;

                case 'SER':
                case 'THR':
                case 'GLN':
                case 'ASN':
                return 0x99eeaa;

                case 'ASP':
                case 'GLU':
                return 0xffddbb;

                case 'HIS':
                case 'LYS':
                case 'ARG':
                case 'PYL':
                return 0xbbddff;

                default:
                return 0x777777;
            }

        	case 'N': return atom.isBackbone() ? 0x000066 : 0x0087FF;
        	case 'O': return atom.isBackbone() ? 0x660000 : 0xFF2222;
        	case 'P': return 0xff8add;
        	case 'S': return 0xffe022;
        	case 'Se': return 0xffb022;
        	case 'Cl': return 0x33cc00;
        	case 'Cu': return 0xe5a072;
        	case 'Zn': return 0x92b0cc;
        	case 'Na': return 0xffcc00;
        	case 'Mg': return 0x99ffcc;
        	case 'K': return 0x9966ff;
        	case 'Ca': return 0xf7f7f7;
        	case 'Fe': return 0x845f42;

        	default: return 0x99aabb;
        }

        return 0xcc00ff;
    };
});

var PODefRgnScheme = NGL.ColormakerRegistry.addScheme(function (params)
{
    this.atomColor = function (atom)
    {
        var resno = atom.resno;
        var i;

        for (i=1; i<=7; i++)
        {
            if (resno >= tmstart[i] && resno <= tmend[i]) return tmcolor[i];
            else if (resno < tmstart[i]) return (i&1) ? 0xccddee : 0xcc9966;
        }

        return 0xcc9966;
    }
});

stage.setParameters(
{
	'backgroundColor': '#080400',
	'ambientColor': '#6cc',
    'ambientIntensity': 0.5,
	'lightColor': '#f9c',
    'lightIntensity': 0.6,
});

// These do not work in Chrome on Linux.
stage.mouseControls.remove( "scroll-ctrl" );
stage.mouseControls.remove( "scroll-shift" );
stage.mouseControls.remove( "scroll-alt" );

// Things better stay where they are.
stage.mouseControls.remove( "drag-ctrl-right ");
stage.mouseControls.remove( "drag-ctrl-left ");

var url = 'http://primaryodors.org/sdf.php';
var molid = getParameterByName('mol') ? getParameterByName('mol') : 'rand';
$.ajax(
{
	url: url,
	cache: false,
	data:
    {
		m: molid
    },
	success: function(result)
    {
    	$('#posey')[0].innerText = result.split("\n")[0];
		var stringBlob = new Blob( [ result ], { type: 'text/plain'} );
        stage.loadFile( stringBlob, { ext: "sdf" } ).then( function( comp )
        {
            comp.addRepresentation( "ball+stick", { multipleBond: true } );
            gmodel.push(comp);
            comp.autoView();
        } );
    }
});

function showPose(p)
{
    var i;

    var pnodz = $('#pnodz')[0];
    pnodz.innerHTML = "Node: ";
    var pmax = 1;

    for (i=0; i<model.length; i++)
    {
        if (mpos[i] == p && mnod[i] == 0)
        {
            model[i].addRepresentation( mrep[i], mrparams[i] );
            if (is_ligand[i]) curr_ligand = model[i];
        }
        else
            model[i].removeAllRepresentations();

        if (mpos[i] > pmax) pmax = mpos[i];

        if (mpos[i] == p && $("#nodebtn"+mnod[i]).length == 0 )
        {
            var nodebtn = document.createElement("a");
            nodebtn.className = "nodebtn";
            if (mnod[i]==0) $(nodebtn).addClass("hilite");
            nodebtn.innerText = mnod[i];
            nodebtn.id = "nodebtn"+mnod[i];
            nodebtn.setAttribute("onclick", "showNode("+mnod[i]+");");

            pnodz.appendChild(nodebtn);
        }
    }

    if (p < 1)
    {
        showPose(1);		// RECURSION!!!
        return;
    }

    if (p > pmax)
    {
        showPose(pmax);		// RECURSION!!!
        return;
    }

    gpose = p;
    gnode = 0;

    $(".posebtn").removeClass("hilite");
    $("#posebtn"+p).addClass("hilite");

    $("#clip").trigger("input");
    if (curr_ligand) $('#ligbtn, #prsv').show();
}

function showNode(n)
{
    var i;
    var nmax = 0;
    for (i=0; i<model.length; i++)
    {
        if (mpos[i] == gpose && mnod[i] == n)
        {
            model[i].addRepresentation( mrep[i], mrparams[i] );
            if (is_ligand[i]) curr_ligand = model[i];
        }
        else
            model[i].removeAllRepresentations();

        if (mpos[i] == gpose && mnod[i] > nmax) nmax = mnod[i];
    }

    if (n < 0)
    {
        showNode(0);		// RECURSION!!!
        return;
    }

    if (n > nmax)
    {
        showNode(nmax);		// RECURSION!!!
        return;
    }

    $(".nodebtn").removeClass("hilite");
    $("#nodebtn"+n).addClass("hilite");

    gnode = parseInt(n);			// Givl upi Javascript from one sddjpar to another.

    $("#clip").trigger("input");
    if (curr_ligand) $('#ligbtn, #prsv').show();
}

$("body").on("keyup", function(e, obj)
{
    var cc = e.key.charCodeAt(0);
    if (e.altkey || e.ctrlkey) return;

    if (e.keyCode >= 37 && e.keyCode <= 40)
    {
        if (e.keyCode == 37) showNode(gnode-1);
        if (e.keyCode == 38) showPose(gpose-1);
        if (e.keyCode == 39) showNode(gnode+1);
        if (e.keyCode == 40) showPose(gpose+1);
        e.preventDefault();
        return;
    }
    else
    {
        if (cc > 0x60 && cc <= 0x7a) showPose(cc-0x60);
        else if (cc >= 0x30 && cc <= 0x39) showNode(cc-0x30);
        else if (cc > 0x40 && cc <= 0x59) showNode(cc-55);
        e.preventDefault();
    }
});

$("#clip").on("input", function (e, obj)
{
    var i;
    var clipValue = parseFloat($("#clip")[0].value);
    for (i=0; i<model.length; i++)
    {
        model[i].eachRepresentation( function(obj)
        {
            lcv = clipValue;
            if (is_ligand[i] && $("#preserve")[0].checked) lcv = 0;
            obj.setParameters( { "clipNear": lcv, } );
        });
    }
    for (i=0; i<gmodel.length; i++)
    {
        gmodel[i].eachRepresentation( function(obj)
        {
            obj.setParameters( { "clipNear": clipValue } );
        });
    }
    stage.setParameters( { "fogNear": (clipValue), "fogFar": Math.max(15+clipValue, 150-clipValue*3), } );
});

function getFileContents(event)
{
    var ff = event.target.files;

    var f = ff[0];
    var r = new FileReader();
    r.fname = f.name;
    $('#ligbtn, #prsv').hide();

    r.onload = (function(lf)
    {
        return function(e)
        {
            return loadFile(e.target.result, e.target.fname);
        };
    })(f);
    r.readAsText(f);
}

function loadFile(fileData, fileName = "")
{
	$("#pleasewait").show();
	window.setTimeout( function()
	{
		$("#pleasewait").hide();
	}, 5381);
	
	$("#affichage").hide();
	
    model = []
    gmodel = [];
    curr_ligand = false;
	resmdl = [];
	restoggled = [];
	sequence = "";
	
    var fext = fileName.substr(fileName.lastIndexOf('.')+1);
    orid = 'OR1A1';
    try
    {
        orid = fileName.match(/(OR[0-9]{1,2}[A-Z]{1,2}|TAAR|VN1R)[0-9]{1,2}/)[0];
    }
    catch (e)
    {
        ;
    }

    $.ajax(
    {
		url: "http://www.primaryodors.org/recepinfo.php",
		data:
        {
			recep: orid,
        },
		fext: fext,
		fileData: fileData,
		success: function(poresult)
        {
            poresult = poresult.split("\n");

            var i;
            for (i=0; i<poresult.length; i++)
            {
                var ln = poresult[i];
                if (ln.substr(0, 6) == "METAL|")
                {
                    var fields = ln.split("|");
                    var j;
                    for (j=1; j<fields.length; j++)
                    {
                        var m = fields[j].match(/[0-9]{3}[:]/);
                        if (m && m.length)
                            mtlcoord.push(parseInt(m[0]));
                    }
                }
                if (ln.substr(0, 7) == "REGION|")
                {
                    var fields = ln.split("|");
                    if (fields[1].substr(0, 3) == "TMR")
                    {
                        var tmr = parseInt(fields[1].substr(3));
                        tmstart[tmr] = parseInt(fields[2]);
                        tmend[tmr] = parseInt(fields[3]);
                    }
                }
            }

            var fext = this.fext;
            switch (fext)
            {
		        case 'sdf':
		        case 'pdb':
                stage.removeAllComponents();
                window.result = fileData;
                
                sequence = "";
                if (fext == 'pdb')
                {
                	var i;
                	var lines = fileData.split("\n");
                    var lres = 0;
                    var tmpstr = "";
                    for (i=0; i<lines.length; i++)
                    {
                        var ln = lines[i];
                        var resno = parseInt(ln.substr(22,4));
                        
                        if (lres != resno)
                        {
                        	if (ln.length > 20)
                        	{
                        		var aa1let = aa_1let_from_3let(ln.substr(17,3).trim());
                        		if (aa1let != '?')
                        		{
				                	var stringBlob6 = new Blob( [tmpstr], { type: 'text/plain'} );
				                	stage.loadFile( stringBlob6, { ext: 'pdb' } ).then( function( comp6 )
				            		{
				            			resmdl.push(comp6);
				            			restoggled.push(0);
				            		});
				            		
				                	lres = resno;
				                	tmpstr = "";
		                    		sequence += aa1let;
                        		}
                    		}
                        }
                        if (ln.length < 20) continue;
                        
                        tmpstr += ln + "\n";
                    }
                    if (tmpstr)
                    {
	                	var stringBlob6a = new Blob( [tmpstr], { type: 'text/plain'} );
	                	stage.loadFile( stringBlob6a, { ext: 'pdb' } ).then( function( comp6a )
	            		{
	            			resmdl.push(comp6a);
	            			restoggled.push(0);
	            		});
    				}
                    
                }
                
                if (fext == 'sdf')
                {
                	$('#posey')[0].innerText = fileData.split("\n")[0];
            	}
                
                var stringBlob = new Blob( [ fileData ], { type: 'text/plain'} );
                stage.loadFile( stringBlob, { ext: fext } ).then( function( comp )
                {
                    if (fext == 'sdf')
                    {
                        comp.addRepresentation( "ball+stick", { multipleBond: true } );
                        gmodel.push(comp);
                    }

                    if (fext == 'pdb')
                    {
                        comp.addRepresentation( "cartoon",
                        {
                            opacity: 0.8,
							colorScheme: PODefRgnScheme,
                            // colorScale: 'rainbow',
                            metalness: 0.15
                        });
                        gmodel.push(comp);

                        var i;
                        var subset = [], shiny = [];
                        var result = window.result.split("\n");
                        for (i=0; i<result.length; i++)
                        {
                            var ln = result[i];
                            var resno = parseInt(ln.substr(22,4));
                            var aname = ln.substr(12,4).trim();
                            if (mtlcoord.indexOf(resno) >= 0
                                    && aname != "N"
                                    && aname != "HN"
                                    && aname != "H"
                                    && aname != "CA"
                                    && aname != "HA"
                                    && aname != "HA1"
                                    && aname != "HA2"
                                    // Due to a bug in NGL, the C and O atoms are required if including CA in
                                    // licorice, ball+stick, or line mode. Hyperball avoids this but is slower to render.
                                    // && aname != "C"
                                    // && aname != "O"
                               ) subset.push(ln);
                            if (ln.substr(17,3) == "MTL") shiny.push(ln);
                        }
                        var stringBlob1 = new Blob( [ subset.join("\n") ], { type: 'text/plain'} );
                        stage.loadFile( stringBlob1, { ext: 'pdb' } ).then( function( comp1 )
                        {
                            comp1.addRepresentation( "licorice",
                            {
                                opacity: 0.7,
								colorScheme: PODefScheme,
                                metalness: 0.13,
                            });
                            gmodel.push(comp1);
                        });
                        var stringBlob2 = new Blob( [ shiny.join("\n") ], { type: 'text/plain'} );
                        stage.loadFile( stringBlob2, { ext: 'pdb' } ).then( function( comp2 )
                        {
                            comp2.addRepresentation( "spacefill",
                            {
                                opacity: 0.95,
								colorScheme: PODefScheme,
                                metalness: 0.53,
                            });
                            gmodel.push(comp2);
                        });
                    }

                    comp.autoView();
                } );
                $("#affichage").show();
                break;

            	case 'txt':
            	case 'dock':
                stage.removeAllComponents();
                var lines = fileData.split("\n");

                $.ajax(
                {
					url: "http://www.primaryodors.org/orpdb.php",
					data:
                    {
						recep: orid,
						mod: "m",
                    },
					success: function(poresult)
                    {
                        var i;
                        var shiny = [];
                        var result = poresult.split("\n");
                        var lres = 0;
                        var tmpstr = "";
                        for (i=0; i<result.length; i++)
                        {
                            var ln = result[i];
                            var resno = parseInt(ln.substr(22,4));
                            var aname = ln.substr(12,4).trim();
                            if (ln.substr(17,3) == "MTL") shiny.push(ln);
                            
                            if (lres != resno)
		                    {
		                    	if (ln.length > 20)
		                    	{
		                    		var aa1let = aa_1let_from_3let(ln.substr(17,3).trim());
		                    		if (aa1let != '?')
		                    		{
						            	var stringBlob5 = new Blob( [tmpstr], { type: 'text/plain'} );
				                    	stage.loadFile( stringBlob5, { ext: 'pdb' } ).then( function( comp5 )
				                		{
				                			resmdl.push(comp5);
				            				restoggled.push(0);
				                		});
						        		
						            	lres = resno;
						            	tmpstr = "";
				                		sequence += aa1let;
				                		
				                		$('#clip').trigger("input");
		                    		}
		                		}
		                    }
		                    if (ln.length < 20) continue;
                            
                            tmpstr += ln + "\n";
                            
                            $('#clip').trigger("input");
                        }
		                if (tmpstr)
		                {
			            	var stringBlob5a = new Blob( [tmpstr], { type: 'text/plain'} );
			            	stage.loadFile( stringBlob5a, { ext: 'pdb' } ).then( function( comp5a )
			        		{
			        			resmdl.push(comp5a);
			        			restoggled.push(0);
			        			$('#clip').trigger("input");
			        		});
						}

                        var stringBlob3 = new Blob( [ poresult ], { type: 'text/plain'} );
                        stage.loadFile( stringBlob3, { ext: 'pdb' } ).then( function( comp3 )
                        {
                            comp3.addRepresentation( "cartoon",
                            {
                                opacity: 0.7,
								colorScheme: PODefRgnScheme,
                                metalness: 0.13,
                            });
                            gmodel.push(comp3);
                            $('#clip').trigger("input");
                        });

                        if (shiny.length)
                        {
                            var stringBlob4 = new Blob( [ shiny.join("\n") ], { type: 'text/plain'} );
                            stage.loadFile( stringBlob4, { ext: 'pdb' } ).then( function( comp4 )
                            {
                                comp4.addRepresentation( "spacefill",
                                {
                                    opacity: 0.95,
									colorScheme: PODefScheme,
                                    metalness: 0.53,
                                });
                                gmodel.push(comp4);
                                $('#clip').trigger("input");
                            });
                        }
                    }
                });

                var posey = $('#posey')[0];
                var i, writing=false, p=0, n=0;
                var protmp = "", ligtmp = "";
                posey.innerHTML = "Pose: ";
                model = [];
                is_ligand = [];
                mpos = [];
                mnod = [];
                for (i=0; i<lines.length; i++)
                {
                    var ln = lines[i];

                    if (ln.substr(0,6) == "Pose: ")
                    {
                        p = parseInt(ln.substr(6));
                        ligtmp += "REMARK 225 " + ln + "\n";
                    }
                    else if (ln.substr(0,6) == "Node: ")
                    {
                        n = parseInt(ln.substr(6));
                        ligtmp += "REMARK 225 " + ln + "\n";
                    }
                    else if (ln.trim() == "PDBDAT:")
                    {
                        if (p>0) writing = true;
                    }
                    else if (ln.trim() == "END")
                    {
                        if (!n)
                        {
                        	var btnid = "posebtn"+p;
                        	
                        	if (!$('#'+btnid).length)
                        	{
		                        var posea = document.createElement("a");
		                        posea.className = "posebtn";
		                        if (p==1) $(posea).addClass("hilite");
		                        posea.innerText = p;
		                        posea.id = btnid;
		                        posea.setAttribute("onclick", "showPose("+p+");");

		                        posey.appendChild(posea);
                            }
                        }

                        if (writing)
                        {
                            var stringBlob = new Blob( [ protmp ], { type: 'text/plain'} );
                            stage.loadFile( stringBlob, { ext: 'pdb', name: p+"|"+n } ).then( function( comp )
                            {
                                var rparam =
                                {
                                    opacity: 0.9,
									colorScheme: PODefSchemeHilite,
                                };

                                model.push(comp);
                                mrep.push("licorice");
                                mrparams.push(rparam);
                                is_ligand.push(0);

                                var lpn = comp.name.split("|");
                                mpos.push(parseInt(lpn[0]));
                                mnod.push(parseInt(lpn[1]));
                                $('#clip').trigger("input");
                            } );

                            stringBlob = new Blob( [ ligtmp ], { type: 'text/plain'} );
                            stage.loadFile( stringBlob, { ext: 'pdb', name: p+"|"+n } ).then( function( comp )
                            {
                                var rparam =
                                {
									multipleBond: true,
                                };

                                model.push(comp);
                                mrep.push("ball+stick");
                                mrparams.push(rparam);
                                is_ligand.push(1);

                                var lpn = comp.name.split("|");
                                mpos.push(parseInt(lpn[0]));
                                mnod.push(parseInt(lpn[1]));
                                $('#clip').trigger("input");
                            } );
                        }
                        writing = false;
                        protmp = ligtmp = "";
                    }
                    else if (writing)
                    {
                        if (ln.substr(17,3) == "LIG")
                            ligtmp += ln + "\n";
                        else
                            protmp += ln + "\n";
                    }
                }
                window.setTimeout(function()
                {
                    showPose(1);
                    // curr_ligand.autoView();
                }, 259);
                $("#affichage").show();
                break;

            	default:
                alert('Unknown file type ' + fext);
            }
            window.setTimeout(function()
            {
            	$("#pleasewait").hide();
            	$('#clip').trigger("input");
                curr_ligand.autoView();
        	}, 503);
        }
    });
}

$('input[type=file]').on('input', getFileContents);
</script>

<div id="citefloat">
	<span>
	</span>
	<br>
	<a href="https://nglviewer.org/ngl/api/">Visualization using NGL Viewer</a>
</div>

<script>
$('#citefloat span')[0].innerText = nglcitation;
</script>

<div id="pleasewait" style="display: none;">
<h2>Please Wait...</h2>
<img src="http://www.primaryodors.org/imgs/Proton_Zundel.gif">
</div>

<div id="seqdd" style="display: none;">
</div>






